
# Detection Name: EC2 Instance Credential Theft

description: |
  This attack simulates the theft of EC2 instance credentials from the Instance Metadata Service. An attacker can use an SSM command to grab temporary access credentials from the metadata service of an EC2 instance. The attacker can then use these AWS credentials to make API calls, either from the attacker's machine or from an EC2 instance spawned in the attacker's AWS account. This type of attack can allow the attacker to gain unauthorized access to resources within the AWS environment.

detection_rule: |
  (in Panther (Python)):
  
  ```python
  def rule(event):
      # Check if the event is an AWS CloudTrail log
      if event.get("eventSource") != "ec2.amazonaws.com":
          return False
  
      # Check if the event is a GetSessionToken API call
      if event.get("eventName") != "GetSessionToken":
          return False
  
      # Check if the event was initiated from the Instance Metadata Service
      if event.get("sourceIPAddress") == "169.254.169.254":
          return True
  
      return False
  
  def title(event):
      return "Potential EC2 Instance Credential Theft Detected"
  
  def description(event):
      return "An AWS CloudTrail log has been detected that indicates a potential attempt to steal EC2 instance credentials from the Instance Metadata Service."
  
  def severity(event):
      return "HIGH"
  ```

tags:
  - auto-generated
  - DIANA
