
# Detection Name: AWS SSO Device Code Phishing

description: |
  The threat described in the summarized intelligence is a phishing attack that targets AWS SSO (Single Sign-On) users by exploiting the device code authentication feature. Attackers can leverage this vulnerability to steal AWS credentials, even when multi-factor authentication (MFA) and IP allow-listing are enabled at the identity provider (IdP) level.

The device code authentication flow in AWS SSO is vulnerable to phishing, as it requires the user to enter a code displayed on the screen into the attacker's phishing site. This allows the attacker to obtain the user's credentials and gain unauthorized access to the victim's AWS accounts.

detection_rule: |
  (in Panther (Python)):

```python
def rule(event):
    # Check if the event is an AWS CloudTrail event
    if event.get("eventSource") != "signin.amazonaws.com":
        return False

    # Check if the event is a device code authentication event
    if event.get("eventName") != "AssumeRoleWithWebIdentity":
        return False

    # Check if the event was successful
    if event.get("errorCode") is not None:
        return False

    # Check if the event was initiated from a suspicious IP address
    if event.get("sourceIPAddress") in suspicious_ip_addresses:
        return True

    return False

log_types = ["aws.cloudtrail"]
description = "Detect AWS SSO device code phishing attempts"
reference = "https://blog.christophetd.fr/phishing-for-aws-credentials-via-aws-sso-device-code-authentication/"
tags = ["AWS", "Phishing", "Credentials"]
```
